<!-- index.html -->
<!doctype html>
<html lang="en">

<head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
    integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous"/>
  <!-- Fontawesome CDN for icons -->
  <link rel="stylesheet" href="https://pro.fontawesome.com/releases/v5.10.0/css/all.css"
    integrity="sha384-AYmEC3Yw5cVb3ZcuHtOA93w35dYTsvhLPVnYs9eStHfGJvOvKxVfELGroGkvsg+p" crossorigin="anonymous" />

  <!-- Javascript files -->
  <script src="/model.js"></script>
  <script src="/messages.js"></script>

  <title>Pet Shop</title>
</head>

<body>


  <!-- Optional JavaScript -->
  <!-- jQuery first, then Popper.js, then Bootstrap JS -->
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"
    integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>

  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
    integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN"
    crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"
    integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV"
    crossorigin="anonymous"></script>
  <!-- Handlebars CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.7.6/handlebars.min.js"
    integrity="sha512-zT3zHcFYbQwjHdKjCu6OMmETx8fJA9S7E6W7kBeFxultf75OPTYUJigEKX58qgyQMi1m1EgenfjMXlRZG8BXaw=="
    crossorigin="anonymous"></script>

  <span id="contents"></span>


  <script>
    Handlebars.registerHelper('formatPrice', function (price) {
      return '$ ' + (Math.round(price * 100) / 100).toFixed(2);
    });
  </script>

  <script>
    Handlebars.registerHelper('formatTax', function (tax) {
      return (Math.round(tax * 100) / 100).toFixed(2) + ' %';
    });
  </script>

  <script>
    Handlebars.registerHelper('formatDate', function (date) {
      const localDate = new Date(date)
      return localDate.getDate() + '/' + (localDate.getMonth() + 1) + '/' + localDate.getFullYear();
    });
  </script>

  <script>
    Handlebars.registerHelper('formatOrderNumber', function (number) {
      return '#' + number;
    });
  </script>

  <script>
    function render(url, container, context) {
      return $.ajax({
        url: url,
        method: 'GET'
      })
        .done(function (source) {
          var template = Handlebars.compile(source);
          var html = template(context);
          $(container).html(html);
        })
        .fail(function (error) {
          console.error('GET ', url, error)
        }) // http GET Error
    }

    function loadPartial(partial, url) {
      return $.ajax({
        url: url,
        method: 'GET'
      })
        .done(function (source) {
          Handlebars.registerPartial(partial, source);
        })
        .fail(function (error) {
          console.error('GET ', url, error)
        }) // http GET Error
    }

    function navigateTo(url, event) {
      event.preventDefault();
      // console.log("navigateTo", Model.user);
      history.pushState(null, '', url);
      route(url);
    }

    function route() {
      // console.log(Model, "route");
      var path = location.pathname;
      var matching = null;
      console.log('Routing ', path);
      var context = {}
      var p = Model.getUserCartQty()
        .done(function (userCartQty) { context.user = userCartQty; })
        .fail(function (error) { console.error(error); })

      context.messages = { success: Messages.success, danger: Messages.danger };
      Messages.clear();

      if (matching = path.match(/^\/index$/)) {
        return Model.getProducts()
          .done(function (products) {
            context.products = products;
          })
          .fail(function () {
            console.error('Cannot retrieve products')
          })
          .always(function () {
            return p.always(function () { return render('/templates/index.hbs', '#contents', context); })
          });
      }
      else if (matching = path.match(/^\/$/)) {
        return Model.getProducts()
          .done(function (result) { context.products = result; })
          .fail(function (error) { console.error(error); })
          .always(function () {
            return p.always(function () { return render('/templates/index.hbs', '#contents', context); })
          });
      }
      else if (matching = path.match(/^\/cart$/)) {
        var cart;
        return Model.getCart()
          .done(function (result) { cart = result; })
          .fail(function (error) { console.error(error); })
          .always(function () {
            return p.always(function () {
              if (context.user)
                context.user.shoppingCart = cart;
              console.log("cart", cart);
              render('/templates/cart.hbs', '#contents', context);
            })
          });
      }
      else if (matching = path.match(/^\/order\/id\/(\d*)$/)) {
        var order
        return Model.getOrder(matching[1])
          .done(function (result) { order = result; })
          .fail(function (error) {
            console.error(error);
            Messages.danger.push(`${error.message}`);
          })
          .always(function () {
            return p.always(function () {
              if (context.user)
                context.order = order;
              render('/templates/order.hbs', '#contents', context);
            })
          })
      }
      else if (matching = path.match(/^\/profile$/)) {
        var orders;
        return Model.getOrders()
          .done(function (ords) {
            orders = ords;
          })
          .fail(function (error) {
            Messages.danger.push(`${error.statusText} (${error.status}): ${error.responseJSON.message}`);
          })
          .always(function () {
            return p.always(function () {
              context.user.orders = orders;
              render('/templates/profile.hbs', '#contents', context);
            })
          })
      }
      else if (matching = path.match(/^\/purchase$/)) {
        var cart;
        return Model.getCart()
          .done(function (result) { cart = result; })
          .fail(function (error) { console.error(error); })
          .always(function () {
            return p.always(function () {
              if (context.user)
                context.user.shoppingCart = cart;
              render('/templates/purchase.hbs', '#contents', context);
            })
          });
      }
      else if (matching = path.match(/^\/signin$/))
        return p.always(function () { render('/templates/signin.hbs', '#contents', context); })
      else if (matching = path.match(/^\/signup$/))
        return p.always(function () { render('/templates/signup.hbs', '#contents', context); })
      else {
        return p.always(function () { render('/templates/not-found.hbs', '#contents', context); })
      }

    }
    $(function () {
      $.when(loadPartial('navBar', '/partials/nav-bar.hbs'),
        loadPartial('footer', '/partials/footer.hbs'),
        loadPartial('header', '/partials/header.hbs'),
        loadPartial('messages', '/partials/messages.hbs'))
        .done(function () {
          route()
        })
      window.addEventListener('popstate', (event) => route(), false);
    })
  </script>
</body>

</html>