{{> navBar this}}
{{> header this}}
{{> messages this}}
<script>
    function checkout_clicked(event) {
        event.preventDefault();
        var form = document.getElementById('purchase-form');
        form.classList.add('was-validated');
        if (form.checkValidity()) {
            purchase = {
                number: new Date().getTime().toString(),
                date: new Date($('#date').val()),
                name: $('#name').val(),
                address: $('#address').val(),
                card_number: $('#cardNumber').val(),
                card_holder: $('#cardHolder').val()
            }
            Model.purchase(purchase)
                .done(function (order) {
                    Messages.success.push(`Order succesfully done!`);
                    navigateTo('/order/id/' + order.number, event);
                })
                .fail(function (error) {
                    Messages.danger.push(`${error.statusText} (${error.status}): ${error.responseJSON.message}`);
                    navigateTo('/purchase', event);
                })
        }
    }
</script>
<main>
    {{#unless this.user.shoppingCart.items.length}}
    <div class="container-fluid p-4">
        <div clas="row">
            <div class="col-md-9">
                <div class="alert alert-danger" role="alert">
                    <div class="d-flex flex-row text-center no-gutters">
                        <i class="fas fa-exclamation-triangle fa-5x"></i>
                        <div class="d-flex">
                            <div class="py-2 px-4 text-left">
                                <p class="mb-2 font-weight-bold">Your shopping cart is empty</p>
                                <div class="h5 font-weight-light">No product items in the basket yet</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {{else}}
    <div class="container">
        <div class="col-xl-12 col-lg-10 col-md-10 col-12">
            <div class="card mb-3">
                <div class="card-body">
                    <h2 class="card-title text-left mt-2 mb-4">Purchase</h2>
                    <hr>
                    <form id="purchase-form" class="form-purchase needs-validation" novalidate>

                        <div class="form-label-group mx-2 my-3">
                            <div class="input-group">
                                <div class="input-group-prepend">
                                    <span class="input-group-text"><i
                                            class="fas fa-calendar-day fa-lg"></i>&nbsp;</span>
                                </div>
                                <input id="date" type="date" class="form-control" placeholder="Date" aria-label="Date"
                                    aria-describedby="basic-addon1" required value>
                                <div class="invalid-feedback">The purchase date field cannot be empty</div>
                            </div>
                        </div>

                        <div class="form-label-group mx-2 my-3">
                            <div class="input-group">
                                <div class="input-group-prepend">
                                    <span class="input-group-text"><i class="fa fa-user fa-lg"></i>&nbsp;</span>
                                </div>
                                <input id="name" type="text" class="form-control" placeholder="Name" aria-label="Name"
                                    aria-describedby="basic-addon1" required autofocus>
                                <div class="invalid-feedback">The name field cannot be empty</div>
                            </div>
                        </div>

                        <div class="form-label-group mx-2 my-3">
                            <div class="input-group">
                                <div class="input-group-prepend">
                                    <span class="input-group-text">&nbsp;<i
                                            class="fas fa-map-marker-alt fa-lg"></i>&nbsp;</span>
                                </div>
                                <input id="address" type="text" class="form-control" placeholder="Address"
                                    aria-label="Address" aria-describedby="basic-addon1" required>
                                <div class="invalid-feedback">The address field cannot be empty</div>
                            </div>
                        </div>

                        <div class="form-label-group mx-2 my-3">
                            <div class="input-group">
                                <div class="input-group-prepend">
                                    <span class="input-group-text"><i class="fab fa-cc-visa fa-lg"></i></span>
                                </div>
                                <input id="cardNumber" type="text" class="form-control" placeholder="Card Number"
                                    aria-label="Card Number" aria-describedby="basic-addon1" required>
                                <div class="invalid-feedback">The card number field cannot be empty</div>
                            </div>
                        </div>

                        <div class="form-label-group mx-2 my-3">
                            <div class="input-group">
                                <div class="input-group-prepend">
                                    <span class="input-group-text"><i class="fas fa-id-card fa-lg"></i></span>
                                </div>
                                <input id="cardHolder" type="text" class="form-control" placeholder="Card Holder"
                                    aria-label="Card Holder" aria-describedby="basic-addon1" required>
                                <div class="invalid-feedback">The card holder field cannot be empty</div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <br />
    <div class="container">
        <div class="col-xl-12 col-lg-10 col-md-10 col-12">
            <div class="card mb-3">
                <div class="card-body">
                    <h2 class="card-title text-left mt-2 mb-4">Products</h2>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="thead-light">
                                <tr>
                                    <th scope="col">Product</th>
                                    <th scope="col">Description</th>
                                    <th scope="col">Qty</th>
                                    <th scope="col">Unit Cost</th>
                                    <th scope="col">Total</th>

                                </tr>
                            </thead>
                            <tbody>
                                {{#each this.user.shoppingCart.items}}
                                <tr>
                                    <th class="align-middle">{{this.title}}</th>
                                    <td class="align-middle">{{this.description}}</td>
                                    <td class="align-middle">{{this.qty}}</td>
                                    <td class="align-middle">{{formatPrice this.unit_cost}}</td>
                                    <td class="align-middle">{{formatPrice this.total}}</td>
                                </tr>
                                {{/each}}
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card-footer bg-light p-2">
                    <div class="d-flex flex-row-reverse text-dark">
                        <div class="py-2 px-4 text-right">
                            <p class="mb-2 font-weight-bold">Total amount</p>
                            <div class="h5 font-weight-light">{{formatPrice this.user.shoppingCart.total}}</div>
                        </div>

                        <div class="py-2  px-4 text-right">
                            <p class="mb-2 font-weight-bold">Tax</p>
                            <div class="h5 font-weight-light">{{formatTax this.user.shoppingCart.tax}}</div>
                        </div>

                        <div class="py-2  px-4 text-right">
                            <p class="mb-2 font-weight-bold">Subtotal</p>
                            <div class="h5 font-weight-light">{{formatPrice this.user.shoppingCart.subtotal}}</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="d-flex flex-row-reverse mb-3">
                <a class="btn btn-lg btn-primary btn-block text-camelcase"
                    onclick="checkout_clicked(event)">Checkout</a>
            </div>
        </div>

    </div>
    <br />
    <br />
    {{/unless}}
</main>
{{> footer this}}